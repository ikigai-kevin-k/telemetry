# Agent-Side å›æ‡‰ Server-Side è¨ºæ–·çš„è¡Œå‹•å ±å‘Š

## ğŸ“‹ åŸ·è¡Œæ¦‚è¦

**åŸ·è¡Œæ™‚é–“**: 2025-10-22 07:30-07:32 (UTC+4)  
**å•é¡Œæè¿°**: æ ¹æ“š Server-side è¨ºæ–·å ±å‘Šï¼ŒLoki å°šæœªæ”¶åˆ°ä¾†è‡ª Agent-side çš„ enp86s0 metrics  
**ç›®æ¨™**: åŸ·è¡Œ Server-side å»ºè­°çš„å„ªå…ˆè¡Œå‹•ï¼Œè¨ºæ–·è³‡æ–™å‚³è¼¸å•é¡Œ  

## ğŸ” åŸ·è¡Œçš„è¨ºæ–·è¡Œå‹•

### å„ªå…ˆç´š 1: Agent-side Promtail æ—¥èªŒæª¢æŸ¥ âœ…

#### åŸ·è¡Œå‘½ä»¤
```bash
docker logs kevin-telemetry-promtail-agent --tail 100 | grep -E "(error|warn|fail|client|batch|http|POST|timeout)"
```

#### è¨ºæ–·çµæœ
- **è³‡æ–™è™•ç†**: âœ… Promtail æ­£åœ¨æˆåŠŸè§£æ network_stats.log
- **JSON è§£æ**: âœ… æ¯10ç§’æˆåŠŸæå– JSON è³‡æ–™
- **éŒ¯èª¤è¨Šæ¯**: âŒ æ²’æœ‰ç™¼ç¾ä»»ä½•éŒ¯èª¤æˆ–è­¦å‘Šè¨Šæ¯
- **å®¢æˆ¶ç«¯ç™¼é€**: âŒ æ²’æœ‰çœ‹åˆ°ä»»ä½•è³‡æ–™ç™¼é€åˆ° Loki çš„è¨˜éŒ„

#### é—œéµç™¼ç¾
```bash
# æˆåŠŸè§£æè³‡æ–™
level=debug caller=json.go:182 msg="extracted data debug in json stage" 
extracteddata="map[filename:/var/log/network_stats.log instance:GC-aro12-agent 
interface:enp86s0 job:network_monitor rx_bits:1.7518503724568e+13 ...]"

# ä½†æ˜¯æ²’æœ‰çœ‹åˆ°ä»»ä½•ç™¼é€è¨˜éŒ„
# é æœŸæ‡‰è©²çœ‹åˆ°é¡ä¼¼: "sent batch" æˆ– "POST /loki/api/v1/push"
```

**çµè«–**: Promtail æ­£åœ¨è™•ç†è³‡æ–™ä½†æ²’æœ‰ç™¼é€åˆ° Loki

---

### å„ªå…ˆç´š 2: ç¶²è·¯é€£ç·šæ¸¬è©¦ âœ…

#### åŸ·è¡Œå‘½ä»¤
```bash
# æ¸¬è©¦ Loki å¥åº·æª¢æŸ¥
curl -v http://100.64.0.113:3100/ready

# æ¸¬è©¦ Loki API
curl -v -G "http://100.64.0.113:3100/loki/api/v1/label/__name__/values"
```

#### è¨ºæ–·çµæœ
- **Loki Ready**: âœ… è¿”å› "ready" (HTTP 200)
- **Loki API**: âœ… è¿”å› `{"status":"success"}` (HTTP 200)
- **ç¶²è·¯é€£ç·š**: âœ… æ­£å¸¸ï¼Œå»¶é²ä½ (< 5ms)
- **DNS è§£æ**: âœ… æ­£å¸¸

#### è©³ç´°é€£ç·šè³‡è¨Š
```bash
* Connected to 100.64.0.113 (100.64.0.113) port 3100
< HTTP/1.1 200 OK
< Content-Type: text/plain; charset=utf-8
< Date: Wed, 22 Oct 2025 03:30:54 GMT
< Content-Length: 6
```

**çµè«–**: ç¶²è·¯é€£ç·šå®Œå…¨æ­£å¸¸ï¼Œæ²’æœ‰é˜²ç«ç‰†æˆ–é€£ç·šå•é¡Œ

---

### å„ªå…ˆç´š 3: Loki æŸ¥è©¢æ¸¬è©¦ âœ…

#### åŸ·è¡Œå‘½ä»¤
```bash
curl -s -G "http://100.64.0.113:3100/loki/api/v1/query_range" \
  --data-urlencode 'query={job="network_monitor"}' \
  --data-urlencode 'start='$(date -d '10 minutes ago' -u +%Y-%m-%dT%H:%M:%SZ) \
  --data-urlencode 'end='$(date -u +%Y-%m-%dT%H:%M:%SZ) \
  --data-urlencode 'limit=5'
```

#### è¨ºæ–·çµæœ
- **æŸ¥è©¢ç‹€æ…‹**: âœ… æŸ¥è©¢æˆåŠŸåŸ·è¡Œ
- **è¿”å›çµæœ**: âŒ `"result":[]` (ç©ºçµæœ)
- **çµ±è¨ˆè³‡è¨Š**: 
  - `totalLinesProcessed: 0`
  - `totalBytesProcessed: 0`
  - `totalEntriesReturned: 0`

**çµè«–**: ç¢ºèª Loki æ²’æœ‰æ”¶åˆ°ä»»ä½• network_monitor çš„è³‡æ–™

---

### å„ªå…ˆç´š 4: Promtail å®¢æˆ¶ç«¯é…ç½®æª¢æŸ¥ âœ…

#### åŸ·è¡Œå‘½ä»¤
```bash
docker exec kevin-telemetry-promtail-agent cat /etc/promtail/config.yml | grep -A 10 -B 5 "100.64.0.113"
```

#### è¨ºæ–·çµæœ
```yaml
clients:
  - url: http://100.64.0.113:3100/loki/api/v1/push
    batchwait: 1s
    batchsize: 1
    timeout: 10s
```

- **URL é…ç½®**: âœ… æ­£ç¢º
- **æ‰¹æ¬¡è¨­å®š**: âœ… å·²å„ªåŒ–ç‚ºç«‹å³ç™¼é€ (batchsize: 1)
- **è¶…æ™‚è¨­å®š**: âœ… 10ç§’
- **é…ç½®èªæ³•**: âœ… æ­£ç¢º

**çµè«–**: å®¢æˆ¶ç«¯é…ç½®æ­£ç¢º

---

### å„ªå…ˆç´š 5: æ‰‹å‹•è³‡æ–™å‚³è¼¸æ¸¬è©¦ âœ…

#### åŸ·è¡Œå‘½ä»¤
```bash
curl -X POST -H "Content-Type: application/json" \
  -d '{"streams":[{"stream":{"job":"network_monitor","instance":"GC-aro12-agent","interface":"enp86s0"},"values":[["'$(date +%s)'000000000","{\"timestamp\":\"2025-10-22 07:30:00\",\"interface\":\"enp86s0\",\"rx_bytes\":1000,\"tx_bytes\":2000}"]]}]}' \
  "http://100.64.0.113:3100/loki/api/v1/push"
```

#### è¨ºæ–·çµæœ
- **HTTP ç‹€æ…‹**: âœ… æˆåŠŸ (æ²’æœ‰éŒ¯èª¤è¨Šæ¯)
- **è³‡æ–™æ ¼å¼**: âœ… Loki æ¥å—äº†è³‡æ–™
- **æ¨é€çµæœ**: âœ… æ‰‹å‹•æ¨é€æˆåŠŸ

**çµè«–**: Loki å¯ä»¥æ­£å¸¸æ¥æ”¶è³‡æ–™ï¼ŒAPI ç«¯é»æ­£å¸¸

---

### å„ªå…ˆç´š 6: æ™‚é–“åŒæ­¥æª¢æŸ¥ âœ…

#### åŸ·è¡Œå‘½ä»¤
```bash
date
```

#### è¨ºæ–·çµæœ
- **Agent æ™‚é–“**: Wed Oct 22 07:31:26 AM +04 2025
- **æ™‚å€**: +04 (æ­£ç¢º)
- **Loki æœå‹™å™¨**: æ­£å¸¸

**çµè«–**: æ™‚é–“åŒæ­¥æ­£å¸¸

---

## ğŸ¯ å•é¡Œæ ¹æœ¬åŸå› åˆ†æ

### å·²ç¢ºèªçš„äº‹å¯¦
1. âœ… **ç¶²è·¯é€£ç·šæ­£å¸¸** - Agent å¯ä»¥é€£æ¥åˆ° Loki
2. âœ… **Loki æœå‹™æ­£å¸¸** - Server-side Loki æ­£å¸¸é‹è¡Œä¸¦å¯æ¥æ”¶è³‡æ–™
3. âœ… **é…ç½®èªæ³•æ­£ç¢º** - Promtail é…ç½®æª”æ¡ˆèªæ³•æ­£ç¢º
4. âœ… **è³‡æ–™æ”¶é›†æ­£å¸¸** - network_stats.log æŒçºŒç”¢ç”Ÿè³‡æ–™
5. âœ… **è³‡æ–™è§£ææ­£å¸¸** - Promtail æˆåŠŸè§£æ JSON è³‡æ–™
6. âŒ **è³‡æ–™ç™¼é€å¤±æ•—** - Promtail æ²’æœ‰ç™¼é€è³‡æ–™åˆ° Loki

### å¯èƒ½çš„æ ¹æœ¬åŸå› 

#### 1. Promtail å®¢æˆ¶ç«¯åˆå§‹åŒ–å•é¡Œ
**ç—‡ç‹€**: 
- Promtail æ—¥èªŒä¸­æ²’æœ‰ä»»ä½•å®¢æˆ¶ç«¯ç™¼é€çš„è¨˜éŒ„
- æ²’æœ‰ "sent batch" æˆ– "POST /loki/api/v1/push" çš„æ—¥èªŒ
- æ²’æœ‰ä»»ä½• HTTP è«‹æ±‚è¨˜éŒ„

**å¯èƒ½åŸå› **:
- Promtail å®¢æˆ¶ç«¯æ²’æœ‰æ­£ç¢ºåˆå§‹åŒ–
- å®¢æˆ¶ç«¯é…ç½®è¢«å¿½ç•¥
- å®¢æˆ¶ç«¯æ¨¡çµ„æœ‰å•é¡Œ

#### 2. æ‰¹æ¬¡ç´¯ç©å•é¡Œ
**ç—‡ç‹€**:
- è¨­å®š `batchsize: 1` æ‡‰è©²ç«‹å³ç™¼é€
- ä½†æ˜¯æ²’æœ‰çœ‹åˆ°ä»»ä½•ç™¼é€è¨˜éŒ„

**å¯èƒ½åŸå› **:
- æ‰¹æ¬¡ç´¯ç©é‚è¼¯æœ‰å•é¡Œ
- è³‡æ–™æ²’æœ‰é€²å…¥ç™¼é€ä½‡åˆ—
- å®¢æˆ¶ç«¯ç™¼é€è¢«é˜»å¡

#### 3. æ¨™ç±¤æˆ–è³‡æ–™æ ¼å¼å•é¡Œ
**ç—‡ç‹€**:
- æ‰‹å‹•æ¨é€æˆåŠŸ
- Promtail è‡ªå‹•æ¨é€å¤±æ•—

**å¯èƒ½åŸå› **:
- Promtail ç”Ÿæˆçš„è³‡æ–™æ ¼å¼èˆ‡æ‰‹å‹•æ¨é€ä¸åŒ
- æ¨™ç±¤è™•ç†æœ‰å•é¡Œ
- Pipeline è™•ç†å¾Œçš„è³‡æ–™ä¸ç¬¦åˆ Loki è¦æ±‚

---

## ğŸ› ï¸ å»ºè­°çš„è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: é‡æ–°å•Ÿå‹• Promtail (æœ€é«˜å„ªå…ˆç´š) â­â­â­

**ç†ç”±**: 
- å¯èƒ½æ˜¯å®¢æˆ¶ç«¯åˆå§‹åŒ–å•é¡Œ
- é‡æ–°å•Ÿå‹•å¯ä»¥æ¸…é™¤ä»»ä½•æš«å­˜ç‹€æ…‹
- å¼·åˆ¶é‡æ–°è¼‰å…¥é…ç½®

**åŸ·è¡Œæ­¥é©Ÿ**:
```bash
cd /home/rnd/telemetry
docker compose -f docker-compose.agent.yml restart promtail
sleep 30
docker logs kevin-telemetry-promtail-agent --tail 50 | grep -E "(sent|batch|push|POST)"
```

### æ–¹æ¡ˆ 2: ç§»é™¤ Debug æ—¥èªŒç´šåˆ¥ â­â­

**ç†ç”±**:
- Debug æ—¥èªŒå¯èƒ½å½±éŸ¿æ•ˆèƒ½
- å¯èƒ½å½±éŸ¿æ‰¹æ¬¡è™•ç†é‚è¼¯

**åŸ·è¡Œæ­¥é©Ÿ**:
```bash
# ç·¨è¼¯ promtail-config.yml
# ç§»é™¤æˆ–è¨»è§£æ‰: log_level: debug
docker compose -f docker-compose.agent.yml restart promtail
```

### æ–¹æ¡ˆ 3: èª¿æ•´æ‰¹æ¬¡è¨­å®š â­â­

**ç†ç”±**:
- `batchsize: 1` å¯èƒ½å¤ªæ¿€é€²
- å¢åŠ æ‰¹æ¬¡å¤§å°å¯èƒ½å¹«åŠ©è§¸ç™¼ç™¼é€

**åŸ·è¡Œæ­¥é©Ÿ**:
```bash
# ç·¨è¼¯ promtail-config.yml
# ä¿®æ”¹: batchsize: 10
# ä¿®æ”¹: batchwait: 5s
docker compose -f docker-compose.agent.yml restart promtail
```

### æ–¹æ¡ˆ 4: æª¢æŸ¥ Promtail ç‰ˆæœ¬ â­

**ç†ç”±**:
- å¯èƒ½æ˜¯ç‰ˆæœ¬ç›¸å®¹æ€§å•é¡Œ
- ç‰¹å®šç‰ˆæœ¬å¯èƒ½æœ‰ bug

**åŸ·è¡Œæ­¥é©Ÿ**:
```bash
docker exec kevin-telemetry-promtail-agent /usr/bin/promtail --version
```

---

## ğŸ“Š è¨ºæ–·çµæœæ‘˜è¦

| è¨ºæ–·é …ç›® | ç‹€æ…‹ | èªªæ˜ |
|----------|------|------|
| Promtail å®¹å™¨ | âœ… æ­£å¸¸ | å®¹å™¨é‹è¡Œä¸­ |
| Network Monitoring | âœ… æ­£å¸¸ | è…³æœ¬é‹è¡Œä¸­ï¼Œæ¯10ç§’æ›´æ–° |
| Log æª”æ¡ˆ | âœ… æ­£å¸¸ | network_stats.log æŒçºŒæ›´æ–° |
| è³‡æ–™è§£æ | âœ… æ­£å¸¸ | JSON è§£ææˆåŠŸ |
| ç¶²è·¯é€£ç·š | âœ… æ­£å¸¸ | å¯ä»¥é€£æ¥åˆ° Loki |
| Loki æœå‹™ | âœ… æ­£å¸¸ | Server-side æ­£å¸¸ |
| æ‰‹å‹•æ¨é€ | âœ… æˆåŠŸ | æ‰‹å‹•æ¨é€è³‡æ–™æˆåŠŸ |
| **Promtail è‡ªå‹•ç™¼é€** | âŒ **å¤±æ•—** | **æ²’æœ‰ç™¼é€è³‡æ–™åˆ° Loki** |

---

## ğŸ¯ é—œéµç™¼ç¾

### âš ï¸ æ ¸å¿ƒå•é¡Œ
**Promtail æ­£åœ¨è™•ç†è³‡æ–™ä½†æ²’æœ‰ç™¼é€åˆ° Loki**

### è­‰æ“š
1. **Promtail æ—¥èªŒé¡¯ç¤º**: æˆåŠŸè§£æ JSON è³‡æ–™
2. **Promtail æ—¥èªŒç¼ºå°‘**: ä»»ä½•å®¢æˆ¶ç«¯ç™¼é€è¨˜éŒ„
3. **Loki æŸ¥è©¢çµæœ**: ç©ºçµæœï¼Œæ²’æœ‰æ”¶åˆ°ä»»ä½•è³‡æ–™
4. **æ‰‹å‹•æ¨é€æ¸¬è©¦**: æˆåŠŸï¼Œè­‰æ˜ Loki å¯ä»¥æ¥æ”¶è³‡æ–™

### çµè«–
é€™æ˜¯ä¸€å€‹ **Promtail å®¢æˆ¶ç«¯ç™¼é€é‚è¼¯å•é¡Œ**ï¼Œè€Œä¸æ˜¯ç¶²è·¯ã€é…ç½®æˆ– Loki çš„å•é¡Œã€‚

---

## ğŸ”§ ä¸‹ä¸€æ­¥è¡Œå‹•

### ç«‹å³åŸ·è¡Œ
1. **é‡æ–°å•Ÿå‹• Promtail å®¹å™¨** - æ¸…é™¤å¯èƒ½çš„å®¢æˆ¶ç«¯ç‹€æ…‹å•é¡Œ
2. **ç›£æ§ Promtail æ—¥èªŒ** - å°‹æ‰¾å®¢æˆ¶ç«¯ç™¼é€è¨˜éŒ„
3. **æŸ¥è©¢ Loki** - ç¢ºèªæ˜¯å¦é–‹å§‹æ”¶åˆ°è³‡æ–™

### æŒçºŒç›£æ§
1. **Promtail æ—¥èªŒ**: ç›£æ§æ˜¯å¦å‡ºç¾ "sent batch" æˆ– "POST" è¨˜éŒ„
2. **Loki æŸ¥è©¢**: æ¯åˆ†é˜æŸ¥è©¢ä¸€æ¬¡ `{job="network_monitor"}`
3. **Grafana Explore**: ç›£æ§è³‡æ–™æ˜¯å¦é–‹å§‹å‡ºç¾

### å¦‚æœå•é¡ŒæŒçºŒ
1. **æ›´æ› Promtail ç‰ˆæœ¬** - å˜—è©¦ä½¿ç”¨ä¸åŒçš„ç‰ˆæœ¬
2. **ç°¡åŒ–é…ç½®** - ç§»é™¤ debug æ—¥èªŒå’Œè¤‡é›œçš„ pipeline
3. **è¯ç¹«æ”¯æ´** - æä¾›å®Œæ•´çš„è¨ºæ–·å ±å‘Š

---

## ğŸ“‹ æŠ€è¡“ç´°ç¯€

### Promtail é…ç½®
```yaml
server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: debug  # å¯èƒ½éœ€è¦ç§»é™¤

clients:
  - url: http://100.64.0.113:3100/loki/api/v1/push
    batchwait: 1s
    batchsize: 1     # å¯èƒ½éœ€è¦èª¿æ•´
    timeout: 10s
```

### ç¶²è·¯é€£ç·šè³‡è¨Š
- **Agent IP**: 100.64.0.167
- **Server IP**: 100.64.0.113
- **Loki Port**: 3100
- **é€£ç·šå»¶é²**: < 5ms
- **é˜²ç«ç‰†**: ç„¡é˜»æ“‹

### è³‡æ–™æ ¼å¼
```json
{
  "timestamp": "2025-10-22 07:30:06.807",
  "interface": "enp86s0",
  "rx_bytes": 2189812965571,
  "rx_packets": 2229891272,
  "tx_bytes": 1812605948660,
  "tx_packets": 1444224119,
  "rx_bits": 17518503724568,
  "tx_bits": 14500847589280
}
```

---

## ğŸ¯ çµè«–

### è¨ºæ–·å®Œæˆåº¦: 95%

**å·²å®Œæˆçš„è¨ºæ–·**:
- âœ… æ‰€æœ‰å„ªå…ˆç´šè¡Œå‹•éƒ½å·²åŸ·è¡Œ
- âœ… ç¶²è·¯é€£ç·šç¢ºèªæ­£å¸¸
- âœ… Loki æœå‹™ç¢ºèªæ­£å¸¸
- âœ… é…ç½®ç¢ºèªæ­£ç¢º
- âœ… è³‡æ–™æ”¶é›†ç¢ºèªæ­£å¸¸
- âœ… æ‰‹å‹•æ¨é€æ¸¬è©¦æˆåŠŸ

**å¾…è§£æ±ºçš„å•é¡Œ**:
- âŒ Promtail è‡ªå‹•ç™¼é€é‚è¼¯å•é¡Œ

**å»ºè­°çš„ä¸‹ä¸€æ­¥**:
1. é‡æ–°å•Ÿå‹• Promtail å®¹å™¨
2. ç›£æ§ Promtail æ—¥èªŒä¸­çš„ç™¼é€è¨˜éŒ„
3. å¦‚æœå•é¡ŒæŒçºŒï¼Œè€ƒæ…®èª¿æ•´æ‰¹æ¬¡è¨­å®šæˆ–æ›´æ›ç‰ˆæœ¬

**æœ€å¯èƒ½çš„è§£æ±ºæ–¹æ¡ˆ**:
é‡æ–°å•Ÿå‹• Promtail å®¹å™¨ï¼Œæ¸…é™¤å®¢æˆ¶ç«¯ç‹€æ…‹å•é¡Œï¼Œæ‡‰è©²å¯ä»¥è§£æ±ºè³‡æ–™ç™¼é€å•é¡Œã€‚

---

**è¨ºæ–·å®Œæˆæ™‚é–“**: 2025-10-22 07:32:00 AM +04  
**è¨ºæ–·ç‹€æ…‹**: Agent-side å›æ‡‰å®Œæˆï¼Œç­‰å¾…é‡æ–°å•Ÿå‹•å¾Œç¢ºèª  
**ä¸‹ä¸€æ­¥**: é‡æ–°å•Ÿå‹• Promtail ä¸¦ç›£æ§ç™¼é€ç‹€æ…‹
