# Loki Server/Agent æ¶æ§‹èªªæ˜

## æ¶æ§‹æ¦‚è¿°

æœ¬å°ˆæ¡ˆå·²å°‡ Loki æ¶æ§‹åˆ†é›¢ç‚º **Server ç«¯** å’Œ **Agent ç«¯**ï¼Œé¡ä¼¼æ–¼ Zabbix çš„ server/agent æ¨¡å¼ã€‚

### ğŸ–¥ï¸ Server ç«¯ (100.64.0.160 - GC-ARO-002-1)
**é‹è¡Œæœå‹™ï¼š**
- Loki Server (Port 3100)
- Zabbix Server (Port 10051)
- Zabbix Web Interface (Port 8080)
- Prometheus (Port 9090)
- Grafana (Port 3000)

**å•Ÿå‹•æ–¹å¼ï¼š**
```bash
./start-server.sh
# æˆ–
docker-compose up -d
```

### ğŸ“± Agent ç«¯ (100.64.0.149 - GC-ARO-001-2)
**é‹è¡Œæœå‹™ï¼š**
- Loki Agent (Promtail)
- Zabbix Agent (Port 10050)

**å•Ÿå‹•æ–¹å¼ï¼š**
```bash
./start-agent.sh
# æˆ–
docker-compose -f docker-compose.agent.yml up -d
```

## ç¶²è·¯æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Server ç«¯                â”‚    â”‚        Agent ç«¯                 â”‚
â”‚    100.64.0.160                â”‚    â”‚    100.64.0.149                â”‚
â”‚                                â”‚    â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    Loki Server          â”‚â—€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”‚    Promtail Agent       â”‚   â”‚
â”‚  â”‚    Port 3100            â”‚   â”‚    â”‚  â”‚    (Log Collector)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â”‚    â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    Zabbix Server        â”‚â—€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”‚    Zabbix Agent          â”‚   â”‚
â”‚  â”‚    Port 10051           â”‚   â”‚    â”‚  â”‚    Port 10050           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â”‚    â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚                                â”‚
â”‚  â”‚    Grafana              â”‚   â”‚    â”‚                                â”‚
â”‚  â”‚    Port 3000            â”‚   â”‚    â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚                                â”‚
â”‚                                â”‚    â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚                                â”‚
â”‚  â”‚    Prometheus           â”‚   â”‚    â”‚                                â”‚
â”‚  â”‚    Port 9090            â”‚   â”‚    â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ—¥èªŒæ”¶é›†é…ç½®

### Agent ç«¯æ—¥èªŒä¾†æº
Promtail åœ¨ Agent ç«¯æ”¶é›†ä»¥ä¸‹æ—¥èªŒæª”æ¡ˆï¼š
- `/var/log/mock_sicbo.log` - Mock Sicbo æ‡‰ç”¨ç¨‹å¼æ—¥èªŒ
- `/var/log/server.log` - ä¼ºæœå™¨æ—¥èªŒ
- `/var/log/tmux-client.log` - Tmux å®¢æˆ¶ç«¯æ—¥èªŒ

### æ—¥èªŒæ¨™ç±¤
æ¯å€‹æ—¥èªŒä¾†æºéƒ½æœƒè¢«æ¨™è¨˜ï¼š
- `job`: æ—¥èªŒä¾†æºé¡å‹ (mock_sicbo, server, tmux_client)
- `instance`: Agent å¯¦ä¾‹è­˜åˆ¥ç¢¼ (GC-ARO-001-2-agent)
- `level`: æ—¥èªŒç´šåˆ¥ (åƒ…é™ mock_sicbo)
- `logger`: è¨˜éŒ„å™¨åç¨± (åƒ…é™ mock_sicbo)

## é…ç½®æª”æ¡ˆ

### Server ç«¯é…ç½®
- `docker-compose.yml` - Server ç«¯æœå‹™é…ç½®
- `loki-config.yml` - Loki Server é…ç½®
- `grafana/provisioning/datasources/loki.yml` - Grafana Loki è³‡æ–™æº

### Agent ç«¯é…ç½®
- `docker-compose.agent.yml` - Agent ç«¯æœå‹™é…ç½®
- `promtail-config.yml` - Promtail Agent é…ç½®
- `zabbix/agent2.conf` - Zabbix Agent é…ç½®

## éƒ¨ç½²æ­¥é©Ÿ

### 1. åœ¨ Server ç«¯ (100.64.0.160) éƒ¨ç½²
```bash
# è¤‡è£½å°ˆæ¡ˆåˆ° server ç«¯
git clone <repository> /path/to/telemetry
cd /path/to/telemetry

# å•Ÿå‹• server æœå‹™
./start-server.sh
```

### 2. åœ¨ Agent ç«¯ (100.64.0.149) éƒ¨ç½²
```bash
# è¤‡è£½å°ˆæ¡ˆåˆ° agent ç«¯
git clone <repository> /path/to/telemetry
cd /path/to/telemetry

# å•Ÿå‹• agent æœå‹™
./start-agent.sh
```

## ç›£æ§å’Œé™¤éŒ¯

### æŸ¥çœ‹æœå‹™ç‹€æ…‹
```bash
# Server ç«¯
docker-compose ps

# Agent ç«¯
docker-compose -f docker-compose.agent.yml ps
```

### æŸ¥çœ‹æ—¥èªŒ
```bash
# Server ç«¯
docker-compose logs -f loki
docker-compose logs -f grafana

# Agent ç«¯
docker-compose -f docker-compose.agent.yml logs -f promtail
```

### æ¸¬è©¦é€£æ¥
```bash
# æ¸¬è©¦ Loki Server é€£æ¥
curl http://100.64.0.160:3100/ready

# æ¸¬è©¦ Promtail åˆ° Loki çš„é€£æ¥
curl -X POST http://100.64.0.160:3100/loki/api/v1/push \
  -H "Content-Type: application/json" \
  -d '{"streams":[{"stream":{"job":"test"},"values":[["'$(date +%s%N)'","test message"]]}]}'
```

## æ³¨æ„äº‹é …

1. **é˜²ç«ç‰†è¨­å®š**ï¼šç¢ºä¿ Server ç«¯çš„ 3100 å’Œ 10051 ç«¯å£å° Agent ç«¯é–‹æ”¾
2. **ç¶²è·¯é€£é€šæ€§**ï¼šç¢ºä¿å…©ç«¯å¯ä»¥é€é Tailscale ç¶²è·¯äº’ç›¸é€šè¨Š
3. **æ—¥èªŒæª”æ¡ˆæ¬Šé™**ï¼šç¢ºä¿ Agent ç«¯æœ‰æ¬Šé™è®€å–æ—¥èªŒæª”æ¡ˆ
4. **æ™‚å€è¨­å®š**ï¼šæ‰€æœ‰æœå‹™éƒ½è¨­å®šç‚º Asia/Taipei æ™‚å€

## æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ
1. **Promtail ç„¡æ³•é€£æ¥åˆ° Loki Server**
   - æª¢æŸ¥ç¶²è·¯é€£é€šæ€§
   - ç¢ºèª Loki Server æ­£åœ¨é‹è¡Œ
   - æª¢æŸ¥é˜²ç«ç‰†è¨­å®š

2. **Zabbix Agent ç„¡æ³•é€£æ¥åˆ° Server**
   - æª¢æŸ¥ Zabbix Server æ˜¯å¦æ­£åœ¨é‹è¡Œ
   - ç¢ºèª Agent é…ç½®ä¸­çš„ Server IP æ­£ç¢º

3. **æ—¥èªŒæ²’æœ‰å‡ºç¾åœ¨ Grafana ä¸­**
   - æª¢æŸ¥ Promtail æ˜¯å¦æ­£åœ¨æ”¶é›†æ—¥èªŒ
   - ç¢ºèª Loki Server æ­£åœ¨æ¥æ”¶æ—¥èªŒ
   - æª¢æŸ¥ Grafana çš„ Loki è³‡æ–™æºé…ç½®
