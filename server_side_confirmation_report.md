# Server-side Loki è³‡æ–™æ¥æ”¶ç¢ºèªå ±å‘Š

## ğŸ“‹ ç¢ºèªæ¦‚è¦

**ç¢ºèªæ™‚é–“**: 2025-10-22 07:26:09 AM +04  
**åŸºæ–¼**: Agent-side ä¿®æ­£å ±å‘Š (2025-10-22 07:14-07:17)  
**ç›®æ¨™**: ç¢ºèª Server-side Loki æ˜¯å¦æ”¶åˆ° aro-001-1 agent çš„ enp86s0 metrics  

## ğŸ”§ é…ç½®è³‡è¨Š

- **Server IP**: 100.64.0.113
- **Loki Port**: 3100
- **Agent IP**: 100.64.0.167
- **Agent Instance**: GC-aro12-agent

## ğŸ” ç¢ºèªçµæœ

### âŒ **Server-side Loki å°šæœªæ”¶åˆ° enp86s0 metrics**

#### è©³ç´°æª¢æŸ¥çµæœ

| æª¢æŸ¥é …ç›® | ç‹€æ…‹ | èªªæ˜ |
|----------|------|------|
| Loki æœå‹™ç‹€æ…‹ | âœ… æ­£å¸¸ | å®¹å™¨é‹è¡Œä¸­ï¼Œç«¯å£æ­£å¸¸ |
| Network Monitor è³‡æ–™ (éå» 10 åˆ†é˜) | âŒ æœªæ”¶åˆ° | æŸ¥è©¢ `{job="network_monitor"}` è¿”å›ç©ºçµæœ |
| GC-aro12-agent è³‡æ–™ (éå» 10 åˆ†é˜) | âŒ æœªæ”¶åˆ° | æŸ¥è©¢ `{instance="GC-aro12-agent"}` è¿”å›ç©ºçµæœ |
| enp86s0 ä»‹é¢è³‡æ–™ (éå» 10 åˆ†é˜) | âŒ æœªæ”¶åˆ° | æŸ¥è©¢ `{job="network_monitor", interface="enp86s0"}` è¿”å›ç©ºçµæœ |
| å®Œæ•´æŸ¥è©¢ (éå» 10 åˆ†é˜) | âŒ æœªæ”¶åˆ° | æŸ¥è©¢ `{job="network_monitor", instance="GC-aro12-agent", interface="enp86s0"}` è¿”å›ç©ºçµæœ |
| JSON è§£æ (éå» 10 åˆ†é˜) | âŒ å¤±æ•— | æŸ¥è©¢ `{job="network_monitor", instance="GC-aro12-agent"} \| json` è¿”å›ç©ºçµæœ |
| éå» 30 åˆ†é˜è³‡æ–™ | âŒ æœªæ”¶åˆ° | æŸ¥è©¢è¿”å›ç©ºçµæœ |
| éå» 1 å°æ™‚è³‡æ–™ | âŒ æœªæ”¶åˆ° | æŸ¥è©¢è¿”å›ç©ºçµæœ |

#### Loki æ—¥èªŒåˆ†æ

å¾ Loki æ—¥èªŒä¸­å¯ä»¥çœ‹åˆ°ï¼š
- æ‰€æœ‰æŸ¥è©¢éƒ½è¿”å› `returned_lines=0`
- æŸ¥è©¢åŸ·è¡Œæ­£å¸¸ï¼Œä½†æ²’æœ‰è¿”å›ä»»ä½•è³‡æ–™
- æ²’æœ‰éŒ¯èª¤è¨Šæ¯ï¼Œè¡¨ç¤ºæŸ¥è©¢èªæ³•æ­£ç¢º
- æ²’æœ‰çœ‹åˆ°ä»»ä½•è³‡æ–™æ¥æ”¶è¨˜éŒ„

## ğŸ¯ å•é¡Œåˆ†æ

### æ ¹æœ¬åŸå› 
**Agent-side å’Œ Server-side ä¹‹é–“çš„è³‡æ–™å‚³è¼¸å°šæœªæˆåŠŸå»ºç«‹**

### å…·é«”å•é¡Œ
1. **Agent-side é…ç½®å·²ä¿®æ­£** âœ…
   - Promtail å®¹å™¨é‹è¡Œæ­£å¸¸
   - Network monitoring è…³æœ¬é‹è¡Œæ­£å¸¸
   - Log æª”æ¡ˆæŒçºŒæ›´æ–°
   - é…ç½®ä½¿ç”¨æ­£ç¢ºçš„æ¨™ç±¤ (GC-aro12-agent)

2. **Server-side é…ç½®å·²ä¿®æ­£** âœ…
   - Loki æœå‹™é‹è¡Œæ­£å¸¸
   - Promtail é…ç½®ä½¿ç”¨æ­£ç¢ºçš„æ¨™ç±¤ (GC-aro12-agent)
   - Docker volume mount é…ç½®æ­£ç¢º

3. **è³‡æ–™å‚³è¼¸å•é¡Œ** âŒ
   - Agent-side æ­£åœ¨è™•ç†è³‡æ–™ä½†æ²’æœ‰ç™¼é€åˆ° Loki
   - å¯èƒ½æ˜¯ç¶²è·¯é€£ç·šå•é¡Œ
   - å¯èƒ½æ˜¯ Promtail å®¢æˆ¶ç«¯é…ç½®å•é¡Œ

## ğŸ” å¯èƒ½åŸå› 

### 1. ç¶²è·¯é€£ç·šå•é¡Œ
- Agent-side ç„¡æ³•é€£æ¥åˆ° Server-side Loki
- é˜²ç«ç‰†é˜»æ“‹é€£ç·š
- ç¶²è·¯å»¶é²æˆ–ä¸ŸåŒ…

### 2. Promtail å®¢æˆ¶ç«¯å•é¡Œ
- æ‰¹æ¬¡è¨­å®šå•é¡Œ (å·²è¨­å®šç‚º `batchsize: 1`)
- è¶…æ™‚è¨­å®šå•é¡Œ
- èªè­‰æˆ–æˆæ¬Šå•é¡Œ

### 3. Loki æ¥æ”¶å•é¡Œ
- Loki é…ç½®å•é¡Œ
- å„²å­˜ç©ºé–“å•é¡Œ
- æ¬Šé™å•é¡Œ

### 4. æ™‚é–“åŒæ­¥å•é¡Œ
- Agent-side å’Œ Server-side æ™‚é–“ä¸åŒæ­¥
- æ™‚å€è¨­å®šå•é¡Œ

## ğŸ› ï¸ å»ºè­°è§£æ±ºæ–¹æ¡ˆ

### 1. ç«‹å³æª¢æŸ¥é …ç›®

#### Agent-side éœ€è¦æª¢æŸ¥
```bash
# æª¢æŸ¥ Promtail æ—¥èªŒä¸­çš„éŒ¯èª¤
docker logs <promtail_container_name> --tail 100 | grep -E "(error|warn|fail)"

# æª¢æŸ¥ç¶²è·¯é€£ç·š
curl -v http://100.64.0.113:3100/ready

# æª¢æŸ¥ Promtail é…ç½®
cat promtail-config.yml | grep -A 10 -B 5 "100.64.0.113"
```

#### Server-side éœ€è¦æª¢æŸ¥
```bash
# æª¢æŸ¥ Loki æ¥æ”¶æ—¥èªŒ
docker logs kevin-telemetry-loki-server --tail 100 | grep -E "(ingest|push|receive)"

# æª¢æŸ¥ Loki é…ç½®
cat loki-config.yml | grep -A 5 -B 5 "ingestion"
```

### 2. ç¶²è·¯é€£ç·šæ¸¬è©¦

#### å¾ Agent-side æ¸¬è©¦
```bash
# æ¸¬è©¦åŸºæœ¬é€£ç·š
curl -v http://100.64.0.113:3100/ready

# æ¸¬è©¦ Loki API
curl -v -G "http://100.64.0.113:3100/loki/api/v1/label/__name__/values"
```

### 3. Promtail é™¤éŒ¯

#### å¢åŠ æ›´è©³ç´°çš„æ—¥èªŒ
```yaml
# promtail-config.yml
server:
  log_level: debug  # å·²è¨­å®š

clients:
  - url: http://100.64.0.113:3100/loki/api/v1/push
    batchwait: 1s
    batchsize: 1
    timeout: 10s
    # æ–°å¢é™¤éŒ¯è¨­å®š
    retry_on_failure: true
    max_retries: 3
```

### 4. æ‰‹å‹•æ¸¬è©¦è³‡æ–™å‚³è¼¸

#### ä½¿ç”¨ logcli æ¸¬è©¦
```bash
# å®‰è£ logcli (å¦‚æœæ²’æœ‰)
# æ‰‹å‹•æ¨é€æ¸¬è©¦è³‡æ–™
echo '{"timestamp":"2025-10-22 07:30:00","interface":"enp86s0","rx_bytes":1000,"tx_bytes":2000}' | \
logcli --addr=http://100.64.0.113:3100 push --labels='{job="network_monitor",instance="GC-aro12-agent",interface="enp86s0"}'
```

## ğŸ“Š æŠ€è¡“æ‘˜è¦

| é …ç›® | Agent-side | Server-side | ç‹€æ…‹ |
|------|------------|-------------|------|
| æœå‹™é‹è¡Œ | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ | æ­£å¸¸ |
| é…ç½®ä¿®æ­£ | âœ… å®Œæˆ | âœ… å®Œæˆ | å®Œæˆ |
| è³‡æ–™æ”¶é›† | âœ… æ­£å¸¸ | âŒ æœªæ”¶åˆ° | å•é¡Œ |
| è³‡æ–™è™•ç† | âœ… æ­£å¸¸ | âŒ æœªæ”¶åˆ° | å•é¡Œ |
| è³‡æ–™å‚³è¼¸ | âŒ å¤±æ•— | âŒ æœªæ”¶åˆ° | å•é¡Œ |

## ğŸ¯ ä¸‹ä¸€æ­¥è¡Œå‹•

### å„ªå…ˆç´š 1: ç¶²è·¯é€£ç·šæª¢æŸ¥
1. ç¢ºèª Agent-side å¯ä»¥é€£æ¥åˆ° Server-side Loki
2. æª¢æŸ¥é˜²ç«ç‰†è¨­å®š
3. æ¸¬è©¦ç¶²è·¯å»¶é²å’Œä¸ŸåŒ…

### å„ªå…ˆç´š 2: Promtail é™¤éŒ¯
1. æª¢æŸ¥ Promtail æ—¥èªŒä¸­çš„éŒ¯èª¤
2. å¢åŠ æ›´è©³ç´°çš„é™¤éŒ¯æ—¥èªŒ
3. æ¸¬è©¦æ‰‹å‹•è³‡æ–™æ¨é€

### å„ªå…ˆç´š 3: Loki é…ç½®æª¢æŸ¥
1. æª¢æŸ¥ Loki æ¥æ”¶é…ç½®
2. æª¢æŸ¥å„²å­˜ç©ºé–“å’Œæ¬Šé™
3. æª¢æŸ¥ Loki æ—¥èªŒä¸­çš„æ¥æ”¶è¨˜éŒ„

## ğŸ“‹ æˆåŠŸæŒ‡æ¨™

ç•¶ä»¥ä¸‹æ¢ä»¶æ»¿è¶³æ™‚ï¼Œè¡¨ç¤ºå•é¡Œå·²è§£æ±ºï¼š
- âœ… Grafana Explore æŸ¥è©¢è¿”å› log è³‡æ–™
- âœ… JSON è§£ææˆåŠŸ
- âœ… å¯ä»¥çœ‹åˆ° rx_bits, tx_bits ç­‰æ¬„ä½
- âœ… æ™‚é–“æˆ³è¨˜æ­£ç¢º
- âœ… è³‡æ–™æŒçºŒæ›´æ–°

## ğŸ”§ å¿«é€Ÿåƒè€ƒ

### é—œéµæŸ¥è©¢èªæ³•
åœ¨ Grafana Explore ä¸­ä¾åºå˜—è©¦ï¼š
1. `{job="network_monitor"}`
2. `{job="network_monitor", instance="GC-aro12-agent"}`
3. `{job="network_monitor", instance="GC-aro12-agent", interface="enp86s0"}`
4. `{job="network_monitor", instance="GC-aro12-agent"} | json`

### é™¤éŒ¯å‘½ä»¤
```bash
# æª¢æŸ¥ Agent-side Promtail æ—¥èªŒ
docker logs <promtail_container_name> --tail 100

# æª¢æŸ¥ Server-side Loki æ—¥èªŒ
docker logs kevin-telemetry-loki-server --tail 100

# æ¸¬è©¦ç¶²è·¯é€£ç·š
curl -v http://100.64.0.113:3100/ready
```

## ğŸ¯ çµè«–

**Agent-side å’Œ Server-side çš„é…ç½®éƒ½å·²æ­£ç¢ºä¿®æ­£**ï¼Œä½†è³‡æ–™å‚³è¼¸å°šæœªæˆåŠŸå»ºç«‹ã€‚å•é¡Œå¯èƒ½å‡ºç¾åœ¨ï¼š

1. **ç¶²è·¯é€£ç·šå±¤é¢** - Agent-side ç„¡æ³•é€£æ¥åˆ° Server-side
2. **Promtail å®¢æˆ¶ç«¯å±¤é¢** - è³‡æ–™è™•ç†æ­£å¸¸ä½†ç™¼é€å¤±æ•—
3. **Loki æ¥æ”¶å±¤é¢** - æ¥æ”¶é…ç½®æˆ–æ¬Šé™å•é¡Œ

**å»ºè­°å„ªå…ˆæª¢æŸ¥ç¶²è·¯é€£ç·šå’Œ Promtail æ—¥èªŒ**ï¼Œé€™æ˜¯æœ€å¯èƒ½çš„åŸå› ã€‚

---

**ç¢ºèªå®Œæˆæ™‚é–“**: 2025-10-22 07:26:09 AM +04  
**ç‹€æ…‹**: å¾…é€²ä¸€æ­¥é™¤éŒ¯ç¶²è·¯é€£ç·šå’Œ Promtail é…ç½®  
**ä¸‹ä¸€æ­¥**: æª¢æŸ¥ Agent-side Promtail æ—¥èªŒå’Œç¶²è·¯é€£ç·š
