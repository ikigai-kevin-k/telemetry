#!/bin/bash

# Grafana Explore Zabbix Query Fix Script
echo "üîß Grafana Explore Zabbix Query Fix"
echo "==================================="

echo "üìä Current Status Analysis:"
echo "==========================="
echo "‚úÖ Zabbix API: Working"
echo "‚úÖ Hosts: Available (6 hosts)"
echo "‚úÖ Items: Available (3 items for GC-aro12-agent)"
echo "‚ö†Ô∏è  History Data: Limited (this is the issue)"
echo "‚úÖ Grafana Access: Working"
echo ""

echo "üîç Root Cause Analysis:"
echo "======================="
echo "The issue is that while Zabbix has current values, it may not have"
echo "sufficient historical data points for Grafana to display graphs."
echo "This is common with newly configured agents or short data collection periods."
echo ""

echo "üí° Solutions for Grafana Explore:"
echo "================================="
echo ""
echo "1. üéØ Use 'Last Value' Query Mode:"
echo "   - In Grafana Explore, change Query Type to 'Last Value'"
echo "   - This will show the current value instead of historical data"
echo "   - Host: GC-aro12-agent"
echo "   - Item: system.cpu.util"
echo ""
echo "2. üìà Use 'Metrics' Query Mode with Extended Time Range:"
echo "   - Change time range to 'Last 6 hours' or 'Last 24 hours'"
echo "   - This gives more time for data collection"
echo "   - Host: GC-aro12-agent"
echo "   - Item: system.cpu.util"
echo ""
echo "3. üîÑ Enable 'Show Disabled Items':"
echo "   - In Options section, enable 'Show disabled items'"
echo "   - This might reveal additional data sources"
echo ""
echo "4. üìä Use 'Table' Visualization:"
echo "   - Change visualization from 'Time series' to 'Table'"
echo "   - This shows current values in tabular format"
echo ""

echo "üß™ Test Queries to Try:"
echo "======================="
echo ""
echo "Query 1 - CPU Usage (Last Value):"
echo "‚Ä¢ Query Type: Last Value"
echo "‚Ä¢ Host: GC-aro12-agent"
echo "‚Ä¢ Item: system.cpu.util"
echo ""
echo "Query 2 - Network Traffic (Last Value):"
echo "‚Ä¢ Query Type: Last Value"
echo "‚Ä¢ Host: GC-aro12-agent"
echo "‚Ä¢ Item: net.if.in[\"eth0\"]"
echo ""
echo "Query 3 - Network Traffic Out (Last Value):"
echo "‚Ä¢ Query Type: Last Value"
echo "‚Ä¢ Host: GC-aro12-agent"
echo "‚Ä¢ Item: net.if.out[\"eth0\"]"
echo ""

echo "üîß Step-by-Step Fix Instructions:"
echo "================================="
echo ""
echo "1. üåê Open Grafana Explore:"
echo "   - Go to http://localhost:3000"
echo "   - Click on 'Explore' in the left menu"
echo ""
echo "2. üì° Select Datasource:"
echo "   - Select 'Zabbix-New' from the datasource dropdown"
echo ""
echo "3. ‚öôÔ∏è  Configure Query:"
echo "   - Set Query Type to 'Last Value'"
echo "   - Leave Group empty"
echo "   - Enter Host: 'GC-aro12-agent'"
echo "   - Enter Item: 'system.cpu.util'"
echo ""
echo "4. üé® Set Visualization:"
echo "   - Change visualization to 'Table' or 'Stat'"
echo "   - This will show the current value"
echo ""
echo "5. ‚ñ∂Ô∏è  Run Query:"
echo "   - Click 'Run query' button"
echo "   - You should see the current CPU usage value"
echo ""

echo "üîÑ Alternative: Use Metrics Query with Extended Time Range:"
echo "=========================================================="
echo ""
echo "1. Set Query Type to 'Metrics'"
echo "2. Change time range to 'Last 6 hours'"
echo "3. Enter Host: 'GC-aro12-agent'"
echo "4. Enter Item: 'system.cpu.util'"
echo "5. Enable 'Show disabled items' in Options"
echo "6. Click 'Run query'"
echo ""

echo "üìã Expected Results:"
echo "==================="
echo "After following these steps, you should see:"
echo "‚Ä¢ CPU Usage: ~0.55% (current value)"
echo "‚Ä¢ Network In: ~2760 bytes (current value)"
echo "‚Ä¢ Network Out: ~2536 bytes (current value)"
echo ""
echo "üéØ Key Points:"
echo "=============="
echo "‚Ä¢ Use 'Last Value' query type for current data"
echo "‚Ä¢ Use 'Table' or 'Stat' visualization for single values"
echo "‚Ä¢ Extend time range if using 'Metrics' query type"
echo "‚Ä¢ Enable 'Show disabled items' if needed"
echo ""
echo "‚úÖ This should resolve the 'No data' issue in Grafana Explore!"
